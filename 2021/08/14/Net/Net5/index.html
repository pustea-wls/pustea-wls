<!-- build time:Sat Aug 14 2021 19:28:24 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/pustea-wls/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/pustea-wls/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="清街余晖" href="https://pustea-wls.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="清街余晖" href="https://pustea-wls.github.io/atom.xml"><link rel="alternate" type="application/json" title="清街余晖" href="https://pustea-wls.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/pustea-wls/css/app.css?v=0.2.5"><meta name="keywords" content="Net,Asp.net Core"><link rel="canonical" href="https://pustea-wls.github.io/2021/08/14/Net/Net5/"><title>如何在Asp.net Core启动的时候，操作数据库 - Net | 清街 = 清街余晖</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">如何在Asp.net Core启动的时候，操作数据库</h1><div class="meta"><span class="item" title="创建时间：2021-08-14 18:08:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-14T18:08:00+08:00">2021-08-14</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/pustea-wls/" rel="start">清街</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipexoj0moj20zk0m8kgu.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4wqtg4j20zk0m8x6p.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giciuv0socj20zk0m8qes.jpg"></li><li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeyvx1d4j20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/pustea-wls/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/pustea-wls/categories/Net/" itemprop="item" rel="index" title="分类于 Net"><span itemprop="name">Net</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://pustea-wls.github.io/2021/08/14/Net/Net5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/pustea-wls/images/avatar.jpg"><meta itemprop="name" content="teapus"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="清街余晖"></span><div class="body md" itemprop="articleBody"><p><span class="exturl" data-url="aHR0cDovL3huLS1Bc3AtbHA2ZTk3M2Vzbng5d2RzNDdjLm5ldA==">最近在研究 Asp.net</span> Core 基于 JWT 授权码模式去实现策略授权 (根据用户的角色动态判断是否拥有对访问接口的权限). 在完成 jwt 的授权码和模拟用户，角色等数据后，想着去在策略授权的时候直接去访问数据库的数据。发现这并不容易。查找一些资料后</p><h3 id="核心代码"><a class="anchor" href="#核心代码">#</a> 核心代码</h3><pre><code class="language-bash">             //连接字符串
            services.AddDbContext&lt;JWTContext&gt;(options =&gt;
            options.UseSqlServer(Configuration.GetConnectionString(&quot;JWTDBConnection&quot;)));

            services.AddScoped&lt;IAppSettings, AppSettings&gt;();

            //读取数据库配置策略授权(重点)
            services.AddOptions&lt;AuthorizationOptions&gt;().Configure&lt;IServiceScopeFactory&gt;((options, sp) =&gt;
            &#123;
              using (var scope = sp.CreateScope())
           &#123;
              IAppSettings settings = scope.ServiceProvider.GetRequiredService&lt;IAppSettings&gt;();
              var Permission = settings.userPermissions();
              options.AddPolicy(&quot;Permission&quot;, policy =&gt; policy.Requirements.Add(Permission));
           &#125;
           &#125;);
</code></pre><p>查看上面的代码我们可以发现，在连接数据的下面。我们让容器中注入了一个服务:<br>[services.AddScoped&lt;IAppSettings, AppSettings&gt;();]</p><h3 id="定义接口"><a class="anchor" href="#定义接口">#</a> 定义接口</h3><pre><code class="language-bash"> public interface IAppSettings  
 &#123;  
      PolicyRequirement userPermissions();  
 &#125;
</code></pre><h3 id="实现接口"><a class="anchor" href="#实现接口">#</a> 实现接口</h3><pre><code class="language-bash">public class AppSettings:IAppSettings
    &#123;
        public JWTContext context;

        public AppSettings(JWTContext context)
        &#123;
            this.context = context;
        &#125;

        public PolicyRequirement userPermissions()
        &#123;
            PolicyRequirement policyRequirement = new PolicyRequirement();

            var _jWTContext = context;
            var perssions = _jWTContext.permssions;
            var roles = _jWTContext.roles;
            policyRequirement.DeniedAction = new PathString(&quot;/api/nopermission&quot;);
            policyRequirement.UserPermissions = (from r in roles
                               join p in perssions
                               on r.Id equals p.RoleId
                               select new UserPermission
                               &#123;
                                   UserName = r.Name,
                                   Url = &quot;/WeatherForecast&quot; + p.Permssions
                               &#125;).ToList();


            return policyRequirement;
        &#125;
</code></pre><h3 id="策略授权的核心代码"><a class="anchor" href="#策略授权的核心代码">#</a> 策略授权的核心代码</h3><pre><code class="language-bash">public class PolicyRequirement: IAuthorizationRequirement
    &#123;

        /// &lt;summary&gt;
        /// 用户权限集合
        /// &lt;/summary&gt;
        public List&lt;UserPermission&gt; UserPermissions &#123; get;  set; &#125;
        /// &lt;summary&gt;
        /// 无权限action
        /// &lt;/summary&gt;
        public string DeniedAction &#123; get; set; &#125;
        /// &lt;summary&gt;
        /// 构造
        /// &lt;/summary&gt;
        public PolicyRequirement()
        &#123;

            //没有权限则跳转到这个路由
            DeniedAction = new PathString(&quot;/api/nopermission&quot;);
            //用户有权限访问的路由配置,当然可以从数据库获取
            UserPermissions = new List&lt;UserPermission&gt; &#123;
                              new UserPermission &#123;  Url=&quot;/WeatherForecast/Tourist&quot;, UserName=&quot;user&quot;&#125;,
                          &#125;;
        &#125;
    &#125;



    /// &lt;summary&gt;
    /// 用户权限承载实体
    /// &lt;/summary&gt;
    public class UserPermission
    &#123;
        /// &lt;summary&gt;
        /// 用户名
        /// &lt;/summary&gt;
        public string UserName &#123; get; set; &#125;
        /// &lt;summary&gt;
        /// 请求Url
        /// &lt;/summary&gt;
        public string Url &#123; get; set; &#125;
    &#125;
</code></pre><pre><code class="language-bash">public class PolicyHandler : AuthorizationHandler&lt;PolicyRequirement&gt;
    &#123;


        protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, PolicyRequirement requirement)
        &#123;
            //var httpContext = ((context.Resource) as Microsoft.AspNetCore.Routing.RouteEndpoint);
            //dynamic httpContext = context.Resource;

            var httpContext = context.Resource as HttpContext;

            var questUrl = httpContext.Request.Path.Value;

            //赋值用户权限
            var userPermissions = requirement.UserPermissions;
            //是否经过验证
            var isAuthenticated = context.User.Identity.IsAuthenticated;

            if (isAuthenticated)
            &#123;
                if (userPermissions.GroupBy(g =&gt; g.Url).Any(w =&gt; w.Key == questUrl))
                &#123;
                    //用户名
                    var userName = context.User.Claims.Where(x=&gt;x.Type==&quot;roless&quot;).First().Value;
                    if (userPermissions.Any(w =&gt; w.UserName == userName &amp;&amp; w.Url== questUrl))
                    &#123;
                        context.Succeed(requirement);
                    &#125;
                    else
                    &#123;
                        //无权限跳转到拒绝页面
                        //context.Fail();
                        //httpContext.Response.Redirect(&quot;https://localhost:5001/api/nopermission&quot;);
                        context.Fail();
                        var Response = httpContext.Response;
                        var message = Encoding.UTF8.GetBytes(&quot;User with Super Admin role cannot be edited&quot;);

                        Response.OnStarting(async () =&gt;
                        &#123;
                            httpContext.Response.StatusCode = 429;
                            await Response.Body.WriteAsync(message, 0, message.Length);
                        &#125;);
                    &#125;
                &#125;
                else
                &#123;
                    context.Succeed(requirement);
                &#125;

            &#125;
            return Task.CompletedTask;
        &#125;
    &#125;
</code></pre><div class="tags"><a href="/pustea-wls/tags/Net/" rel="tag"><i class="ic i-tag"></i> Net</a> <a href="/pustea-wls/tags/Asp-net-Core/" rel="tag"><i class="ic i-tag"></i> Asp.net Core</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-08-14 19:23:51" itemprop="dateModified" datetime="2021-08-14T19:23:51+08:00">2021-08-14</time> </span><span id="2021/08/14/Net/Net5/" class="item leancloud_visitors" data-flag-title="如何在Asp.net Core启动的时候，操作数据库" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/pustea-wls/images/wechatpay.png" alt="teapus 微信支付"><p>微信支付</p></div><div><img data-src="/pustea-wls/images/alipay.png" alt="teapus 支付宝"><p>支付宝</p></div><div><img data-src="/pustea-wls/images/paypal.png" alt="teapus 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>teapus <i class="ic i-at"><em>@</em></i>清街余晖</li><li class="link"><strong>本文链接：</strong> <a href="https://pustea-wls.github.io/2021/08/14/Net/Net5/" title="如何在Asp.net Core启动的时候，操作数据库">https://pustea-wls.github.io/2021/08/14/Net/Net5/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"><a href="/pustea-wls/2021/08/14/hello-world/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclfdu6exj20zk0m87hw.jpg" title="Hello World"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Net</span><h3>Hello World</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">核心代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">实现接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%8E%88%E6%9D%83%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">策略授权的核心代码</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/pustea-wls/2021/08/14/hello-world/" rel="bookmark" title="Hello World">Hello World</a></li><li class="active"><a href="/pustea-wls/2021/08/14/Net/Net5/" rel="bookmark" title="如何在Asp.net Core启动的时候，操作数据库">如何在Asp.net Core启动的时候，操作数据库</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="teapus" data-src="/pustea-wls/images/avatar.jpg"><p class="name" itemprop="name">teapus</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/pustea-wls/archives/"><span class="count">2</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/pustea-wls/categories/"><span class="count">1</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/pustea-wls/tags/"><span class="count">2</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="https:&#x2F;&#x2F;github.com&#x2F;yourname"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span></div><ul class="menu"><li class="item"><a href="/pustea-wls/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/pustea-wls/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item"><a href="/pustea-wls/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/pustea-wls/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/pustea-wls/categories/Net/" title="分类于 Net">Net</a></div><span><a href="/pustea-wls/2021/08/14/Net/Net5/" title="如何在Asp.net Core启动的时候，操作数据库">如何在Asp.net Core启动的时候，操作数据库</a></span></li><li class="item"><div class="breadcrumb"><a href="/pustea-wls/categories/Net/" title="分类于 Net">Net</a></div><span><a href="/pustea-wls/2021/08/14/hello-world/" title="Hello World">Hello World</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">teapus @ 清街</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/08/14/Net/Net5/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/pustea-wls/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->