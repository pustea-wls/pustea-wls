{
    "version": "https://jsonfeed.org/version/1",
    "title": "清街余晖",
    "subtitle": "",
    "icon": "https://pustea-wls.github.io/images/favicon.ico",
    "description": "",
    "home_page_url": "https://pustea-wls.github.io",
    "items": [
        {
            "id": "https://pustea-wls.github.io/2021/08/28/Iview%E4%B8%AD%E7%9A%84%E6%A8%A1%E6%80%81%E6%A1%86/",
            "url": "https://pustea-wls.github.io/2021/08/28/Iview%E4%B8%AD%E7%9A%84%E6%A8%A1%E6%80%81%E6%A1%86/",
            "title": "在render函数中使用this.$Modal.confirm模态框访问不到当前vue组件实例(this指向问题)",
            "date_published": "2021-08-28T10:58:00.000Z",
            "content_html": "<p>有一个小的功能在 iview 的 table 组件中。点击删除后弹出一个模态框，接着点击确定后删除数据。<br />\n在用 render 函数时遇到一个小的问题</p>\n<h2 id=\"初始化页面数据\"><a class=\"anchor\" href=\"#初始化页面数据\">#</a> 初始化页面数据</h2>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token function\">loadInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>method<span class=\"token punctuation\">.</span><span class=\"token constant\">GET</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://localhost:5001/api/Query\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><h2 id=\"render函数中删除数据\"><a class=\"anchor\" href=\"#render函数中删除数据\">#</a> Render 函数中删除数据</h2>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>on<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function-variable function\">click</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$Modal<span class=\"token punctuation\">.</span><span class=\"token function\">confirm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        title<span class=\"token operator\">:</span> <span class=\"token string\">\"确定删除吗？\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">async</span> <span class=\"token function\">onOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">var</span> <span class=\"token punctuation\">&#123;</span> code <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            method<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token string\">\"https://localhost:5001/api/Delete\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>code <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$Message<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"删除成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure><p><img data-src=\"vue-1.png\" alt=\"\" /></p>\n<h2 id=\"将click方法修改\"><a class=\"anchor\" href=\"#将click方法修改\">#</a> 将 Click 方法修改</h2>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>on<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function-variable function\">click</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$Modal<span class=\"token punctuation\">.</span><span class=\"token function\">confirm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// 接受外面的变量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">let</span> loadInit <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loadInit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        title<span class=\"token operator\">:</span> <span class=\"token string\">\"确定删除吗？\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">async</span> <span class=\"token function\">onOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">var</span> <span class=\"token punctuation\">&#123;</span> code <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            method<span class=\"token punctuation\">.</span><span class=\"token constant\">DELETE</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token string\">\"https://localhost:5001/api/Delete\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span> id<span class=\"token operator\">:</span> row<span class=\"token punctuation\">.</span>id <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>code <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token function\">loadInit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>$Message<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"删除成功\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>           <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr></table></figure>",
            "tags": [
                "Vue",
                "Vue"
            ]
        },
        {
            "id": "https://pustea-wls.github.io/2021/08/14/Net/Net5/",
            "url": "https://pustea-wls.github.io/2021/08/14/Net/Net5/",
            "title": "如何在Asp.net Core启动的时候，操作数据库",
            "date_published": "2021-08-14T10:08:00.000Z",
            "content_html": "<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1Bc3AtbHA2ZTk3M2Vzbng5d2RzNDdjLm5ldA==\">最近在研究 Asp.net</span> Core 基于 JWT 授权码模式去实现策略授权 (根据用户的角色动态判断是否拥有对访问接口的权限). 在完成 jwt 的授权码和模拟用户，角色等数据后，想着去在策略授权的时候直接去访问数据库的数据。发现这并不容易。查找一些资料后</p>\n<h3 id=\"核心代码\"><a class=\"anchor\" href=\"#核心代码\">#</a> 核心代码</h3>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>&#x2F;&#x2F; 连接字符串</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> services.AddDbContext&lt;JWTContext&gt;(options &#x3D;&gt;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> options.UseSqlServer (Configuration.GetConnectionString (&quot;JWTDBConnection&quot;)));</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> services.AddScoped&lt;IAppSettings, AppSettings&gt;();</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> &#x2F;&#x2F; 读取数据库配置策略授权 (重点)</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> services.AddOptions&lt;AuthorizationOptions&gt;().Configure&lt;IServiceScopeFactory&gt;((options, sp) &#x3D;&gt;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> &#123;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    using (var scope &#x3D; sp.CreateScope ())</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        IAppSettings settings &#x3D; scope.ServiceProvider.GetRequiredService&lt;IAppSettings&gt;();</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        var Permission &#x3D; settings.userPermissions ();</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        options.AddPolicy (&quot;Permission&quot;, policy &#x3D;&gt; policy.Requirements.Add (Permission));</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>&#125;);</pre></td></tr></table></figure><p>查看上面的代码我们可以发现，在连接数据的下面。我们让容器中注入了一个服务:<br />\n <code>services.AddScoped&lt;IAppSettings, AppSettings&gt;()</code></p>\n<h3 id=\"定义接口\"><a class=\"anchor\" href=\"#定义接口\">#</a> 定义接口</h3>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>public interface IAppSettings  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre> &#123;  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      PolicyRequirement userPermissions();  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre> &#125;</pre></td></tr></table></figure><h3 id=\"实现接口\"><a class=\"anchor\" href=\"#实现接口\">#</a> 实现接口</h3>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>public class AppSettings:IAppSettings</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        public JWTContext context;</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        public AppSettings(JWTContext context)</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        &#123;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            this.context &#x3D; context;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        public PolicyRequirement userPermissions()</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        &#123;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            PolicyRequirement policyRequirement &#x3D; new PolicyRequirement();</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            var _jWTContext &#x3D; context;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            var perssions &#x3D; _jWTContext.permssions;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            var roles &#x3D; _jWTContext.roles;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            policyRequirement.DeniedAction &#x3D; new PathString(&quot;&#x2F;api&#x2F;nopermission&quot;);</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            policyRequirement.UserPermissions &#x3D; (from r in roles</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                               join p in perssions</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                               on r.Id equals p.RoleId</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                               select new UserPermission</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                               &#123;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                                   UserName &#x3D; r.Name,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                                   Url &#x3D; &quot;&#x2F;WeatherForecast&quot; + p.Permssions</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                               &#125;).ToList();</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            return policyRequirement;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        &#125;</pre></td></tr></table></figure><h3 id=\"策略授权的核心代码\"><a class=\"anchor\" href=\"#策略授权的核心代码\">#</a> 策略授权的核心代码</h3>\n<figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>public class PolicyRequirement: IAuthorizationRequirement</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        &#x2F;&#x2F;&#x2F; 用户权限集合</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        public List&lt;UserPermission&gt; UserPermissions &#123; get;  set; &#125;</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        &#x2F;&#x2F;&#x2F; 无权限 action</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        public string DeniedAction &#123; get; set; &#125;</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        &#x2F;&#x2F;&#x2F; 构造</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        public PolicyRequirement ()</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        &#123;</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            &#x2F;&#x2F; 没有权限则跳转到这个路由</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            DeniedAction &#x3D; new PathString (&quot;&#x2F;api&#x2F;nopermission&quot;);</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            &#x2F;&#x2F; 用户有权限访问的路由配置，当然可以从数据库获取</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            UserPermissions &#x3D; new List&lt;UserPermission&gt; &#123;</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                              new UserPermission &#123;  Url&#x3D;&quot;&#x2F;WeatherForecast&#x2F;Tourist&quot;, UserName&#x3D;&quot;user&quot;&#125;,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                          &#125;;</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    &#x2F;&#x2F;&#x2F; 用户权限承载实体</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    public class UserPermission</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        &#x2F;&#x2F;&#x2F; 用户名</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        public string UserName &#123; get; set; &#125;</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        &#x2F;&#x2F;&#x2F; 请求 Url</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        public string Url &#123; get; set; &#125;</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    &#125;</pre></td></tr></table></figure><figure class=\"highlight raw\"><figcaption data-lang=\"\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>public class PolicyHandler : AuthorizationHandler&lt;PolicyRequirement&gt;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    &#123;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        protected override Task HandleRequirementAsync (AuthorizationHandlerContext context, PolicyRequirement requirement)</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        &#123;</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            &#x2F;&#x2F;var httpContext &#x3D; ((context.Resource) as Microsoft.AspNetCore.Routing.RouteEndpoint);</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            &#x2F;&#x2F;dynamic httpContext &#x3D; context.Resource;</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            var httpContext &#x3D; context.Resource as HttpContext;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            var questUrl &#x3D; httpContext.Request.Path.Value;</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            &#x2F;&#x2F; 赋值用户权限</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            var userPermissions &#x3D; requirement.UserPermissions;</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            &#x2F;&#x2F; 是否经过验证</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            var isAuthenticated &#x3D; context.User.Identity.IsAuthenticated;</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            if (isAuthenticated)</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            &#123;</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                if (userPermissions.GroupBy (g &#x3D;&gt; g.Url).Any (w &#x3D;&gt; w.Key &#x3D;&#x3D; questUrl))</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                &#123;</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                    &#x2F;&#x2F; 用户名</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    var userName &#x3D; context.User.Claims.Where (x&#x3D;&gt;x.Type&#x3D;&#x3D;&quot;roless&quot;).First ().Value;</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    if (userPermissions.Any (w &#x3D;&gt; w.UserName &#x3D;&#x3D; userName &amp;&amp; w.Url&#x3D;&#x3D; questUrl))</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    &#123;</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        context.Succeed (requirement);</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    &#125;</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                    else</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                    &#123;</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                        &#x2F;&#x2F; 无权限跳转到拒绝页面</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                        &#x2F;&#x2F;context.Fail ();</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                        &#x2F;&#x2F;httpContext.Response.Redirect (&quot;https:&#x2F;&#x2F;localhost:5001&#x2F;api&#x2F;nopermission&quot;);</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        context.Fail ();</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                        var Response &#x3D; httpContext.Response;</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        var message &#x3D; Encoding.UTF8.GetBytes (&quot;User with Super Admin role cannot be edited&quot;);</pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        Response.OnStarting (async () &#x3D;&gt;</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                        &#123;</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                            httpContext.Response.StatusCode &#x3D; 429;</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                            await Response.Body.WriteAsync (message, 0, message.Length);</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                        &#125;);</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                    &#125;</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                &#125;</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                else</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                &#123;</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    context.Succeed (requirement);</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                &#125;</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            &#125;</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            return Task.CompletedTask;</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        &#125;</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    &#125;</pre></td></tr></table></figure>",
            "tags": [
                "Net",
                "Net",
                "Asp.net Core"
            ]
        },
        {
            "id": "https://pustea-wls.github.io/2021/08/14/hello-world/",
            "url": "https://pustea-wls.github.io/2021/08/14/hello-world/",
            "title": "Hello World",
            "date_published": "2021-08-14T10:08:00.000Z",
            "content_html": "<p><code>I can do all things</code></p>\n",
            "tags": [
                "Net"
            ]
        }
    ]
}